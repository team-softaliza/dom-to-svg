{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import * as postcss from 'postcss'\nimport cssValueParser from 'postcss-value-parser'\n\nimport { isCSSFontFaceRule, unescapeStringValue } from './css.js'\nimport { svgNamespace, xlinkNamespace } from './dom.js'\nimport { createStackingLayers } from './stacking.js'\nimport { DomToSvgOptions, walkNode } from './traversal.js'\nimport { createIdGenerator } from './util.js'\n\nexport { DomToSvgOptions }\n\nexport function documentToSVG(document: Document, options?: DomToSvgOptions): XMLDocument {\n\treturn elementToSVG(document.documentElement, options)\n}\n\nexport function elementToSVG(element: Element, options?: DomToSvgOptions): XMLDocument {\n\tconst svgDocument = element.ownerDocument.implementation.createDocument(svgNamespace, 'svg', null)\n\n\tconst svgElement = (svgDocument.documentElement as unknown) as SVGSVGElement\n\tsvgElement.setAttribute('xmlns', svgNamespace)\n\tsvgElement.setAttribute('xmlns:xlink', xlinkNamespace)\n\tsvgElement.append(\n\t\tsvgDocument.createComment(\n\t\t\t// \"--\" is invalid in comments, percent-encode.\n\t\t\t` Generated by dom-to-svg from ${element.ownerDocument.location.href.replace(/--/g, '%2D%2D')} `\n\t\t)\n\t)\n\n\t// Copy @font-face rules\n\tconst styleElement = svgDocument.createElementNS(svgNamespace, 'style')\n\tfor (const styleSheet of element.ownerDocument.styleSheets) {\n\t\ttry {\n\t\t\t// Make font URLs absolute (need to be resolved relative to the stylesheet)\n\t\t\tfor (const rule of styleSheet.rules ?? []) {\n\t\t\t\tif (!isCSSFontFaceRule(rule)) {\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\t\t\t\tconst styleSheetHref = rule.parentStyleSheet?.href\n\t\t\t\tif (styleSheetHref) {\n\t\t\t\t\t// Note: Firefox does not implement rule.style.src, need to use rule.style.getPropertyValue()\n\t\t\t\t\tconst parsedSourceValue = cssValueParser(rule.style.getPropertyValue('src'))\n\t\t\t\t\tparsedSourceValue.walk(node => {\n\t\t\t\t\t\tif (node.type === 'function' && node.value === 'url' && node.nodes[0]) {\n\t\t\t\t\t\t\tconst urlArgumentNode = node.nodes[0]\n\t\t\t\t\t\t\tif (urlArgumentNode.type === 'string' || urlArgumentNode.type === 'word') {\n\t\t\t\t\t\t\t\turlArgumentNode.value = new URL(\n\t\t\t\t\t\t\t\t\tunescapeStringValue(urlArgumentNode.value),\n\t\t\t\t\t\t\t\t\tstyleSheetHref\n\t\t\t\t\t\t\t\t).href\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t// Firefox does not support changing `src` on CSSFontFaceRule declarations, need to use PostCSS.\n\t\t\t\t\tconst updatedFontFaceRule = postcss.parse(rule.cssText)\n\t\t\t\t\tupdatedFontFaceRule.walkDecls('src', declaration => {\n\t\t\t\t\t\tdeclaration.value = cssValueParser.stringify(parsedSourceValue.nodes)\n\t\t\t\t\t})\n\t\t\t\t\tstyleElement.append(updatedFontFaceRule.toString() + '\\n')\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.error('Error resolving @font-face src URLs for styleSheet, skipping', styleSheet, error)\n\t\t}\n\t}\n\tsvgElement.append(styleElement)\n\n\twalkNode(element, {\n\t\tsvgDocument,\n\t\tcurrentSvgParent: svgElement,\n\t\tstackingLayers: createStackingLayers(svgElement),\n\t\tparentStackingLayer: svgElement,\n\t\tgetUniqueId: createIdGenerator(),\n\t\tlabels: new Map<HTMLLabelElement, string>(),\n\t\tancestorMasks: [],\n\t\toptions: {\n\t\t\tcaptureArea: options?.captureArea ?? element.getBoundingClientRect(),\n\t\t\tkeepLinks: options?.keepLinks !== false,\n\t\t},\n\t})\n\n\tconst bounds = options?.captureArea ?? element.getBoundingClientRect()\n\tsvgElement.setAttribute('width', bounds.width.toString())\n\tsvgElement.setAttribute('height', bounds.height.toString())\n\tsvgElement.setAttribute('viewBox', `${bounds.x} ${bounds.y} ${bounds.width} ${bounds.height}`)\n\n\treturn svgDocument\n}\n\nexport { inlineResources } from './inline.js'\n"]}