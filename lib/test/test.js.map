{"version":3,"file":"test.js","sourceRoot":"","sources":["../../src/test/test.ts"],"names":[],"mappings":"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","sourcesContent":["import { writeFile } from 'fs/promises'\nimport { Server } from 'net'\nimport * as path from 'path'\nimport { fileURLToPath, pathToFileURL } from 'url'\nimport * as util from 'util'\n\nimport { MODE, Polly } from '@pollyjs/core'\nimport FSPersister from '@pollyjs/persister-fs'\nimport { assert } from 'chai'\nimport delay from 'delay'\nimport ParcelBundler from 'parcel-bundler'\nimport pixelmatch from 'pixelmatch'\nimport { PNG } from 'pngjs'\nimport puppeteer, { ResourceType } from 'puppeteer'\nimport css from 'tagged-template-noop'\nimport formatXML from 'xml-formatter'\n\nimport { PuppeteerAdapter } from './PuppeteerAdapter.js'\nimport { createDeferred, readFileOrUndefined } from './util.js'\n\n// Reduce log verbosity\nutil.inspect.defaultOptions.depth = 0\nutil.inspect.defaultOptions.maxStringLength = 80\n\nPolly.register(PuppeteerAdapter as any)\n\ndeclare global {\n\tfunction resolveSVG(svg: string): void\n\tfunction rejectSVG(error: unknown): void\n}\n\nconst defaultViewport: puppeteer.Viewport = {\n\twidth: 1200,\n\theight: 800,\n}\n\nconst mode = (process.env.POLLY_MODE || 'replay') as MODE\nconsole.log('Using Polly mode', mode)\n\nconst root = path.resolve(path.dirname(fileURLToPath(import.meta.url)), '..', '..')\n\ndescribe('documentToSVG()', () => {\n\tlet browser: puppeteer.Browser\n\tlet server: Server\n\tbefore('Launch devserver', async () => {\n\t\tconst bundler = new ParcelBundler(path.resolve(root, 'lib/test/injected-script.js'), {\n\t\t\thmr: false,\n\t\t\tsourceMaps: false, // Workaround for \"Unterminated regular expression\" Parcel bug\n\t\t\tminify: false,\n\t\t\tautoInstall: false,\n\t\t})\n\t\tserver = await bundler.serve(8080)\n\t})\n\tbefore('Launch browser', async () => {\n\t\tbrowser = await puppeteer.launch({\n\t\t\theadless: true,\n\t\t\tdefaultViewport,\n\t\t\tdevtools: true,\n\t\t\targs: [\n\t\t\t\t'--window-size=1920,1080',\n\t\t\t\t'--lang=en-US',\n\t\t\t\t'--disable-web-security',\n\t\t\t\t'--font-render-hinting=none',\n\t\t\t\t'--enable-font-antialiasing',\n\t\t\t],\n\t\t\ttimeout: 0,\n\t\t\t// slowMo: 100,\n\t\t})\n\t})\n\n\tafter('Close browser', () => browser?.close())\n\tafter('Close devserver', done => server?.close(done))\n\n\tconst snapshotDirectory = path.resolve(root, 'src/test/snapshots')\n\tconst sites = [\n\t\tnew URL('https://sourcegraph.com/search'),\n\t\tnew URL('https://sourcegraph.com/extensions'),\n\t\tnew URL('https://www.google.com?hl=en'),\n\t\tnew URL('https://news.ycombinator.com'),\n\t\tnew URL(\n\t\t\t'https://github.com/felixfbecker/dom-to-svg/blob/fee7e1e7b63c888bc1c5205126b05c63073ebdd3/.vscode/settings.json'\n\t\t),\n\t]\n\tfor (const url of sites) {\n\t\tconst encodedName = encodeURIComponent(url.href)\n\t\tconst svgFilePath = path.resolve(snapshotDirectory, encodedName + '.svg')\n\t\tdescribe(url.href, () => {\n\t\t\tlet polly: Polly\n\t\t\tlet page: puppeteer.Page\n\t\t\tbefore('Open tab and setup Polly', async () => {\n\t\t\t\tpage = await browser.newPage()\n\t\t\t\tawait page.setRequestInterception(true)\n\t\t\t\tawait page.setBypassCSP(true)\n\t\t\t\t// Prevent Google cookie consent prompt\n\t\t\t\tif (url.hostname.endsWith('google.com')) {\n\t\t\t\t\tawait page.setCookie({ name: 'CONSENT', value: 'YES+DE.de+V14+BX', domain: '.google.com' })\n\t\t\t\t}\n\t\t\t\tawait page.setExtraHTTPHeaders({\n\t\t\t\t\t'Accept-Language': 'en-US',\n\t\t\t\t\tDNT: '1',\n\t\t\t\t})\n\t\t\t\tpage.on('console', message => {\n\t\t\t\t\tconsole.log('🖥  ' + (message.type() !== 'log' ? message.type().toUpperCase() : ''), message.text())\n\t\t\t\t})\n\n\t\t\t\tconst requestResourceTypes: ResourceType[] = [\n\t\t\t\t\t'xhr',\n\t\t\t\t\t'fetch',\n\t\t\t\t\t'document',\n\t\t\t\t\t'script',\n\t\t\t\t\t'stylesheet',\n\t\t\t\t\t'image',\n\t\t\t\t\t'font',\n\t\t\t\t\t'other',\n\t\t\t\t]\n\t\t\t\tpolly = new Polly(url.href, {\n\t\t\t\t\tmode,\n\t\t\t\t\trecordIfMissing: false,\n\t\t\t\t\trecordFailedRequests: true,\n\t\t\t\t\tflushRequestsOnStop: false,\n\t\t\t\t\tlogging: false,\n\t\t\t\t\tadapters: [PuppeteerAdapter as any],\n\t\t\t\t\tadapterOptions: {\n\t\t\t\t\t\tpuppeteer: {\n\t\t\t\t\t\t\tpage,\n\t\t\t\t\t\t\trequestResourceTypes,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t// Very lenient, but pages often have very complex URL parameters and this usually works fine.\n\t\t\t\t\tmatchRequestsBy: {\n\t\t\t\t\t\tmethod: true,\n\t\t\t\t\t\tbody: false,\n\t\t\t\t\t\turl: {\n\t\t\t\t\t\t\tusername: false,\n\t\t\t\t\t\t\tpassword: false,\n\t\t\t\t\t\t\thostname: true,\n\t\t\t\t\t\t\tpathname: true,\n\t\t\t\t\t\t\tquery: url.hostname !== 'www.google.com',\n\t\t\t\t\t\t\thash: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t\torder: false,\n\t\t\t\t\t\theaders: false,\n\t\t\t\t\t},\n\t\t\t\t\tpersister: FSPersister,\n\t\t\t\t\tpersisterOptions: {\n\t\t\t\t\t\tfs: {\n\t\t\t\t\t\t\trecordingsDir: path.resolve(root, 'src/test/recordings'),\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t})\n\t\t\t\tpolly.server.get('http://localhost:8080/*').passthrough()\n\t\t\t\tpolly.server.get('data:*').passthrough()\n\t\t\t\tpolly.server.any('https://sentry.io/*rest').intercept((request, response) => {\n\t\t\t\t\tresponse.sendStatus(204)\n\t\t\t\t})\n\t\t\t\tpolly.server.any('https://www.googletagmanager.com/*').intercept((request, response) => {\n\t\t\t\t\tresponse.sendStatus(204)\n\t\t\t\t})\n\t\t\t\tpolly.server.any('https://api.github.com/_private/*rest').intercept((request, response) => {\n\t\t\t\t\tresponse.sendStatus(204)\n\t\t\t\t})\n\t\t\t\tpolly.server.any('https://collector.githubapp.com/*rest').intercept((request, response) => {\n\t\t\t\t\tresponse.sendStatus(204)\n\t\t\t\t})\n\t\t\t\tpolly.server.any('https://www.google.com/gen_204').intercept((request, response) => {\n\t\t\t\t\tresponse.sendStatus(204)\n\t\t\t\t})\n\t\t\t})\n\n\t\t\tbefore('Go to page', async () => {\n\t\t\t\tawait page.goto(url.href, {\n\t\t\t\t\twaitUntil: url.host === 'github.com' ? 'domcontentloaded' : 'networkidle2',\n\t\t\t\t\ttimeout: 60000,\n\t\t\t\t})\n\t\t\t\tawait page.waitForTimeout(2000)\n\t\t\t\tawait page.mouse.click(0, 0)\n\t\t\t\t// Override system font to Arial to make screenshots deterministic cross-platform\n\t\t\t\tawait page.addStyleTag({\n\t\t\t\t\tcontent: css`\n\t\t\t\t\t\t@font-face {\n\t\t\t\t\t\t\tfont-family: system-ui;\n\t\t\t\t\t\t\tfont-style: normal;\n\t\t\t\t\t\t\tfont-weight: 300;\n\t\t\t\t\t\t\tsrc: local('Arial');\n\t\t\t\t\t\t}\n\t\t\t\t\t\t@font-face {\n\t\t\t\t\t\t\tfont-family: -apple-system;\n\t\t\t\t\t\t\tfont-style: normal;\n\t\t\t\t\t\t\tfont-weight: 300;\n\t\t\t\t\t\t\tsrc: local('Arial');\n\t\t\t\t\t\t}\n\t\t\t\t\t\t@font-face {\n\t\t\t\t\t\t\tfont-family: BlinkMacSystemFont;\n\t\t\t\t\t\t\tfont-style: normal;\n\t\t\t\t\t\t\tfont-weight: 300;\n\t\t\t\t\t\t\tsrc: local('Arial');\n\t\t\t\t\t\t}\n\t\t\t\t\t`,\n\t\t\t\t})\n\t\t\t\t// await new Promise<never>(() => {})\n\t\t\t})\n\n\t\t\tafter('Stop Polly', () => polly?.stop())\n\t\t\tafter('Close page', () => page?.close())\n\n\t\t\tlet svgPage: puppeteer.Page\n\t\t\tbefore('Produce SVG', async () => {\n\t\t\t\tconst svgDeferred = createDeferred<string>()\n\t\t\t\tawait page.exposeFunction('resolveSVG', svgDeferred.resolve)\n\t\t\t\tawait page.exposeFunction('rejectSVG', svgDeferred.reject)\n\t\t\t\tconst injectedScriptUrl = 'http://localhost:8080/injected-script.js'\n\t\t\t\tawait page.addScriptTag({ url: injectedScriptUrl })\n\t\t\t\tconst generatedSVGMarkup = await Promise.race([\n\t\t\t\t\tsvgDeferred.promise.catch(({ message, ...error }) =>\n\t\t\t\t\t\tPromise.reject(Object.assign(new Error(message), error))\n\t\t\t\t\t),\n\t\t\t\t\tdelay(120000).then(() => Promise.reject(new Error('Timeout generating SVG'))),\n\t\t\t\t])\n\t\t\t\tconsole.log('Formatting SVG')\n\t\t\t\tconst generatedSVGMarkupFormatted = formatXML(generatedSVGMarkup)\n\t\t\t\tawait writeFile(svgFilePath, generatedSVGMarkupFormatted)\n\t\t\t\tsvgPage = await browser.newPage()\n\t\t\t\tawait svgPage.goto(pathToFileURL(svgFilePath).href)\n\t\t\t\t// await new Promise<never>(() => {})\n\t\t\t})\n\t\t\tafter('Close SVG page', () => svgPage?.close())\n\n\t\t\tit('produces SVG that is visually the same', async () => {\n\t\t\t\tconsole.log('Bringing page to front')\n\t\t\t\tawait page.bringToFront()\n\t\t\t\tconsole.log('Snapshotting the original page')\n\t\t\t\tconst expectedScreenshot = await page.screenshot({ encoding: 'binary', type: 'png', fullPage: false })\n\t\t\t\tawait writeFile(path.resolve(snapshotDirectory, `${encodedName}.expected.png`), expectedScreenshot)\n\t\t\t\tconsole.log('Snapshotting the SVG')\n\t\t\t\tconst actualScreenshot = await svgPage.screenshot({ encoding: 'binary', type: 'png', fullPage: false })\n\t\t\t\tawait writeFile(path.resolve(snapshotDirectory, `${encodedName}.actual.png`), actualScreenshot)\n\t\t\t\tconsole.log('Snapshotted, comparing PNGs')\n\n\t\t\t\tconst expectedPNG = PNG.sync.read(expectedScreenshot)\n\t\t\t\tconst actualPNG = PNG.sync.read(actualScreenshot)\n\t\t\t\tconst { width, height } = expectedPNG\n\t\t\t\tconst diffPNG = new PNG({ width, height })\n\n\t\t\t\tconst differentPixels = pixelmatch(expectedPNG.data, actualPNG.data, diffPNG.data, width, height, {\n\t\t\t\t\tthreshold: 0.3,\n\t\t\t\t})\n\t\t\t\tconst differenceRatio = differentPixels / (width * height)\n\n\t\t\t\tconst diffPngBuffer = PNG.sync.write(diffPNG)\n\t\t\t\tawait writeFile(path.resolve(snapshotDirectory, `${encodedName}.diff.png`), diffPngBuffer)\n\n\t\t\t\tif (process.env.TERM_PROGRAM === 'iTerm.app') {\n\t\t\t\t\tconst nameBase64 = Buffer.from(encodedName + '.diff.png').toString('base64')\n\t\t\t\t\tconst diffBase64 = diffPngBuffer.toString('base64')\n\t\t\t\t\tconsole.log(`\\u001B]1337;File=name=${nameBase64};inline=1;width=1080px:${diffBase64}\\u0007`)\n\t\t\t\t}\n\n\t\t\t\tconst differencePercentage = differenceRatio * 100\n\n\t\t\t\tconsole.log('Difference', differencePercentage.toFixed(2) + '%')\n\n\t\t\t\tassert.isBelow(differencePercentage, 0.5) // %\n\t\t\t})\n\n\t\t\tit('produces SVG with the expected accessibility tree', async function () {\n\t\t\t\tconst snapshotPath = path.resolve(snapshotDirectory, encodedName + '.a11y.json')\n\t\t\t\tconst expectedAccessibilityTree = await readFileOrUndefined(snapshotPath)\n\t\t\t\tconst actualAccessibilityTree = await svgPage.accessibility.snapshot()\n\t\t\t\tawait writeFile(snapshotPath, JSON.stringify(actualAccessibilityTree, null, 2))\n\t\t\t\tif (!expectedAccessibilityTree) {\n\t\t\t\t\tthis.skip()\n\t\t\t\t}\n\t\t\t\tassert.deepStrictEqual(\n\t\t\t\t\tactualAccessibilityTree,\n\t\t\t\t\tJSON.parse(expectedAccessibilityTree),\n\t\t\t\t\t'Expected accessibility tree to be the same as snapshot'\n\t\t\t\t)\n\t\t\t})\n\t\t})\n\t}\n})\n"]}