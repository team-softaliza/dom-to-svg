{"version":3,"file":"stacking.js","sourceRoot":"","sources":["../src/stacking.ts"],"names":[],"mappings":"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","sourcesContent":["import { isInFlow, isInline, isPositioned } from './css.js'\nimport { svgNamespace } from './dom.js'\n\ndeclare global {\n\tinterface CSSStyleDeclaration {\n\t\t// @font-face\n\t\tsrc: string\n\n\t\tmixBlendMode: string\n\t\tmaskBorder: string\n\t\tisolation: string\n\t\twebkitOverflowScrolling: string\n\t\tcontain: string\n\t\tdisplayOutside: string\n\t\tdisplayInside: string\n\t}\n}\n\nconst stackingContextEstablishingProperties = new Set<string>([\n\t'clipPath',\n\t'contain',\n\t'filter',\n\t'isolation',\n\t'mask',\n\t'maskBorder',\n\t'maskImage',\n\t'mixBlendMode',\n\t'opacity',\n\t'perspective',\n\t'position',\n\t'transform',\n\t'webkitOverflowScrolling',\n\t'zIndex',\n])\n\nexport function establishesStackingContext(\n\tstyles: CSSStyleDeclaration,\n\tparentStyles: CSSStyleDeclaration | null\n): boolean {\n\t// https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context\n\treturn !!(\n\t\t((styles.position === 'absolute' || styles.position === 'relative') && styles.zIndex !== 'auto') ||\n\t\tstyles.position === 'fixed' ||\n\t\tstyles.position === 'sticky' ||\n\t\t(parentStyles &&\n\t\t\t(parentStyles.display === 'flex' || parentStyles.display === 'grid') &&\n\t\t\tstyles.zIndex !== 'auto') ||\n\t\tparseFloat(styles.opacity) !== 1 ||\n\t\tstyles.mixBlendMode !== 'normal' ||\n\t\tstyles.transform !== 'none' ||\n\t\tstyles.filter !== 'none' ||\n\t\tstyles.perspective !== 'none' ||\n\t\tstyles.clipPath !== 'none' ||\n\t\tstyles.mask !== 'none' ||\n\t\tstyles.maskImage !== 'none' ||\n\t\tstyles.maskBorder !== 'none' ||\n\t\tstyles.isolation === 'isolate' ||\n\t\tstyles.webkitOverflowScrolling === 'touch' ||\n\t\tstyles.contain === 'layout' ||\n\t\tstyles.contain === 'paint' ||\n\t\tstyles.contain === 'strict' ||\n\t\tstyles.contain === 'content' ||\n\t\tstyles.willChange.split(',').some(property => stackingContextEstablishingProperties.has(property.trim()))\n\t)\n}\n\nexport interface StackingLayers {\n\t/** 1. The background and borders of the element forming the stacking context. */\n\treadonly rootBackgroundAndBorders: SVGGElement\n\n\t/** 2. The child stacking contexts with negative stack levels (most negative first). */\n\treadonly childStackingContextsWithNegativeStackLevels: SVGGElement\n\n\t/** 3. The in-flow, non-inline-level, non-positioned descendants. */\n\treadonly inFlowNonInlineNonPositionedDescendants: SVGGElement\n\n\t/** 4. The non-positioned floats. */\n\treadonly nonPositionedFloats: SVGGElement\n\n\t/** 5. The in-flow, inline-level, non-positioned descendants, including inline tables and inline blocks. */\n\treadonly inFlowInlineLevelNonPositionedDescendants: SVGGElement\n\n\t/** 6. The child stacking contexts with stack level 0 and the positioned descendants with stack level 0. */\n\treadonly childStackingContextsWithStackLevelZeroAndPositionedDescendantsWithStackLevelZero: SVGGElement\n\n\t/** 7. The child stacking contexts with positive stack levels (least positive first). */\n\treadonly childStackingContextsWithPositiveStackLevels: SVGGElement\n}\n\nconst STACKING_LAYER_NAMES: readonly (keyof StackingLayers)[] = [\n\t'rootBackgroundAndBorders',\n\t'childStackingContextsWithNegativeStackLevels',\n\t'inFlowNonInlineNonPositionedDescendants',\n\t'nonPositionedFloats',\n\t'inFlowInlineLevelNonPositionedDescendants',\n\t'childStackingContextsWithStackLevelZeroAndPositionedDescendantsWithStackLevelZero',\n\t'childStackingContextsWithPositiveStackLevels',\n]\n\nfunction createStackingLayer(parent: SVGElement, layerName: keyof StackingLayers): SVGGElement {\n\tconst layer = parent.ownerDocument.createElementNS(svgNamespace, 'g')\n\tlayer.dataset.stackingLayer = layerName\n\tparent.append(layer)\n\treturn layer\n}\n\nexport function createStackingLayers(container: SVGElement): StackingLayers {\n\tcontainer.dataset.stackingContext = 'true'\n\treturn {\n\t\trootBackgroundAndBorders: createStackingLayer(container, 'rootBackgroundAndBorders'),\n\t\tchildStackingContextsWithNegativeStackLevels: createStackingLayer(\n\t\t\tcontainer,\n\t\t\t'childStackingContextsWithNegativeStackLevels'\n\t\t),\n\t\tinFlowNonInlineNonPositionedDescendants: createStackingLayer(\n\t\t\tcontainer,\n\t\t\t'inFlowNonInlineNonPositionedDescendants'\n\t\t),\n\t\tnonPositionedFloats: createStackingLayer(container, 'nonPositionedFloats'),\n\t\tinFlowInlineLevelNonPositionedDescendants: createStackingLayer(\n\t\t\tcontainer,\n\t\t\t'inFlowInlineLevelNonPositionedDescendants'\n\t\t),\n\t\tchildStackingContextsWithStackLevelZeroAndPositionedDescendantsWithStackLevelZero: createStackingLayer(\n\t\t\tcontainer,\n\t\t\t'childStackingContextsWithStackLevelZeroAndPositionedDescendantsWithStackLevelZero'\n\t\t),\n\t\tchildStackingContextsWithPositiveStackLevels: createStackingLayer(\n\t\t\tcontainer,\n\t\t\t'childStackingContextsWithPositiveStackLevels'\n\t\t),\n\t}\n}\n\nexport function determineStackingLayer(\n\tstyles: CSSStyleDeclaration,\n\tparentStyles: CSSStyleDeclaration | null\n): keyof StackingLayers | undefined {\n\t// https://www.w3.org/TR/CSS22/visuren.html#layers\n\t// https://www.w3.org/TR/CSS22/zindex.html\n\n\t// Note: the root element is not handled here, but in handleElement().\n\tconst zIndex = styles.zIndex !== 'auto' ? parseInt(styles.zIndex, 10) : undefined\n\tif (zIndex !== undefined && zIndex < 0 && establishesStackingContext(styles, parentStyles)) {\n\t\treturn 'childStackingContextsWithNegativeStackLevels'\n\t}\n\tif (isInFlow(styles) && !isInline(styles) && !isPositioned(styles)) {\n\t\treturn 'inFlowNonInlineNonPositionedDescendants'\n\t}\n\tif (!isPositioned(styles) && styles.float !== 'none') {\n\t\treturn 'nonPositionedFloats'\n\t}\n\tif (isInFlow(styles) && isInline(styles) && !isPositioned(styles)) {\n\t\treturn 'inFlowInlineLevelNonPositionedDescendants'\n\t}\n\tif (zIndex === 0 && (isPositioned(styles) || establishesStackingContext(styles, parentStyles))) {\n\t\treturn 'childStackingContextsWithStackLevelZeroAndPositionedDescendantsWithStackLevelZero'\n\t}\n\tif (zIndex !== undefined && zIndex > 0 && establishesStackingContext(styles, parentStyles)) {\n\t\treturn 'childStackingContextsWithPositiveStackLevels'\n\t}\n\treturn undefined\n}\n\nexport function sortChildrenByZIndex(parent: SVGElement): void {\n\tconst sorted = [...parent.children].sort((a, b) => {\n\t\tconst zIndexA = (a as SVGElement).dataset.zIndex\n\t\tconst zIndexB = (b as SVGElement).dataset.zIndex\n\t\tif (!zIndexA || !zIndexB) {\n\t\t\t// E.g. a <clipPath>\n\t\t\treturn 0\n\t\t}\n\t\treturn parseInt(zIndexA, 10) - parseInt(zIndexB, 10)\n\t})\n\tfor (const child of sorted) {\n\t\tparent.append(child)\n\t}\n}\n\nexport function sortStackingLayerChildren(stackingLayers: StackingLayers): void {\n\tsortChildrenByZIndex(stackingLayers.childStackingContextsWithNegativeStackLevels)\n\tsortChildrenByZIndex(stackingLayers.childStackingContextsWithPositiveStackLevels)\n}\n\n/**\n * Removes all stacking layers that are empty.\n */\nexport function cleanupStackingLayerChildren(stackingLayers: StackingLayers): void {\n\tfor (const name of STACKING_LAYER_NAMES) {\n\t\tconst layer = stackingLayers[name]\n\t\tif (!layer.hasChildNodes()) {\n\t\t\tlayer.remove()\n\t\t}\n\t}\n}\n"]}